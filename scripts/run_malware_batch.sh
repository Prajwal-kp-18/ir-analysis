#!/bin/bash
#
# run_malware_batch.sh
# Run malware analysis in small batches with robust error handling
#

set -e

MALWARE_DIR="/home/prajwal/Documents/ir-analysis/malware"
RESULTS_DIR="/home/prajwal/Documents/ir-analysis/results/malware"
BATCH_SIZE=3
TIMEOUT_PER_SAMPLE=300  # 5 minutes per sample

# Create results directory
mkdir -p "$RESULTS_DIR"

# Get all malware samples
mapfile -t SAMPLES < <(find "$MALWARE_DIR" -type f \( -name "*.elf" -o -name "*.exe" \) | sort)
TOTAL=${#SAMPLES[@]}

echo "=========================================="
echo "Malware Batch Analysis"
echo "=========================================="
echo "Total samples: $TOTAL"
echo "Batch size: $BATCH_SIZE"
echo "Timeout per sample: ${TIMEOUT_PER_SAMPLE}s"
echo "=========================================="

# Initialize or read checkpoint
CHECKPOINT_FILE="$RESULTS_DIR/checkpoint.txt"
START_INDEX=0
if [ -f "$CHECKPOINT_FILE" ]; then
    START_INDEX=$(cat "$CHECKPOINT_FILE")
    echo "Resuming from sample $START_INDEX"
fi

# Process in batches
for ((i=$START_INDEX; i<$TOTAL; i+=$BATCH_SIZE)); do
    END=$((i + BATCH_SIZE))
    if [ $END -gt $TOTAL ]; then
        END=$TOTAL
    fi
    
    echo ""
    echo "=========================================="
    echo "Processing batch: samples $((i+1)) to $END of $TOTAL"
    echo "=========================================="
    
    # Create temporary directory for this batch
    TEMP_DIR=$(mktemp -d "$RESULTS_DIR/batch_XXXXXX")
    
    # Copy samples to temp directory
    BATCH_SAMPLES=()
    for ((j=i; j<$END; j++)); do
        SAMPLE="${SAMPLES[$j]}"
        SAMPLE_NAME=$(basename "$SAMPLE")
        cp "$SAMPLE" "$TEMP_DIR/"
        BATCH_SAMPLES+=("$SAMPLE_NAME")
        echo "  [$((j+1))/$TOTAL] Queued: $SAMPLE_NAME"
    done
    
    # Run analysis on this batch with timeout
    echo ""
    echo "Starting analysis..."
    
    BATCH_TIMEOUT=$((TIMEOUT_PER_SAMPLE * BATCH_SIZE + 60))
    
    timeout $BATCH_TIMEOUT bash -c "
        source /home/prajwal/Documents/ir-analysis/.venv/bin/activate
        cd /home/prajwal/Documents/ir-analysis
        SAMPLES_DIR='$TEMP_DIR' \
        RESULTS_DIR='$RESULTS_DIR' \
        ENABLE_BAP=true \
        ENABLE_LLVM=true \
        TIMEOUT_SECONDS=$TIMEOUT_PER_SAMPLE \
        ./scripts/run_all.sh 2>&1 | tee -a '$RESULTS_DIR/batch_$i.log'
    " || {
        echo "⚠ Batch timeout or error occurred, continuing..."
    }
    
    # Clean up temp directory
    rm -rf "$TEMP_DIR"
    
    # Update checkpoint
    echo "$END" > "$CHECKPOINT_FILE"
    
    # Show progress
    PROCESSED=$((END))
    PERCENT=$((PROCESSED * 100 / TOTAL))
    echo ""
    echo "Progress: $PROCESSED/$TOTAL ($PERCENT%)"
    
    # Brief pause between batches
    sleep 2
done

# Clean up checkpoint
rm -f "$CHECKPOINT_FILE"

echo ""
echo "=========================================="
echo "✓ Batch processing complete!"
echo "=========================================="
echo "Results saved to: $RESULTS_DIR/summary.csv"
echo ""

# Show final statistics
if [ -f "$RESULTS_DIR/summary.csv" ]; then
    TOTAL_ANALYZED=$(tail -n +2 "$RESULTS_DIR/summary.csv" | wc -l)
    echo "Total analyses: $TOTAL_ANALYZED"
fi
